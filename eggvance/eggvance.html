<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>eggvance</title>
  </head>
  <body>
    <canvas id="canvas" style="background: white"></canvas>
    <input id="rom-input" type="file" accept=".gba" style="display: none" onchange="Module.loadRom()">
    <input id="save-input" type="file" accept=".sav" style="display: none" onchange="Module.loadSave()">
    <div style="display: flex; margin-top: 8px">
      <button onclick="inputRom.click()">Load rom</button>
      <button onclick="inputSave.click()" style="margin-left: 8px">Load save</button>
    </div>
    <script type="text/javascript">
      const inputRom  = document.getElementById('rom-input');
      const inputSave = document.getElementById('save-input');

      class FileSystem {
        constructor() {
          this.id = 0;
        }

        write(data) {
          const filename = `data${this.id++}.bin`;
          FS.writeFile(filename, data);

          return filename;
        }
      }

      var Module = {
        fs: new FileSystem(),
        canvas: document.getElementById('canvas'),
        preInit() {
          FS.writeFile('eggvance.ini', `
            [general]
            # Relative or absolute save path
            # An empty value stores save files next to the ROM
            save_path =
            # Relative or absolute BIOS file path
            bios_file =
            # Skip the BIOS intro sequence
            bios_skip = true
            # Validate the BIOS hash
            bios_hash = true

            [cartridge]
            # Force a cartridge save type
            # Possible values: auto, sram, flash64, flash128, eeprom
            save_type = auto
            # Force a cartridge GPIO type
            # Possible values: auto, rtc
            gpio_type = auto

            # Custom framerates accessible with shortcuts
            [framerate]
            custom_1 = 119.474
            custom_2 = 238.948
            custom_3 = 358.442
            custom_4 = 477.896

            # The following sections define custom key bindings
            # Possible keyboard values: https://github.com/SDL-mirror/SDL/blob/release-2.0.12/src/events/SDL_keyboard.c#L282
            # Possible controller values: https://github.com/SDL-mirror/SDL/blob/release-2.0.12/src/joystick/SDL_gamecontroller.c#L494
            [controls_keyboard]
            a      = U
            b      = H
            up     = W
            down   = S
            left   = A
            right  = D
            start  = G
            select = F
            l      = Q
            r      = I

            [controls_controller]
            a      = B
            b      = A
            up     = DpUp
            down   = DpDown
            left   = DpLeft
            right  = DpRight
            start  = Start
            select = Back
            l      = LeftShoulder
            r      = RightShoulder

            [shortcuts_keyboard]
            reset       = R
            fullscreen  = F11
            fr_hardware = 1
            fr_custom_1 = 2
            fr_custom_2 = 3
            fr_custom_3 = 4
            fr_custom_4 = 5
            fr_unbound  = 6

            [shortcuts_controller]
            reset       =
            fullscreen  =
            fr_hardware =
            fr_custom_1 =
            fr_custom_2 =
            fr_custom_3 =
            fr_custom_4 =
            fr_unbound  =
          `);
        },
        async readUrl(url) {
          return new Promise(resolve => {
            const request = new XMLHttpRequest();

            request.open('GET', url);
            request.responseType = 'arraybuffer';
            request.onload = event => {
              resolve(new Uint8Array(request.response));
            }
            request.send();
          });
        },
        async readFile(input) {
          return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => {
              resolve(new Uint8Array(reader.result));
            }
            reader.readAsArrayBuffer(input.files[0]);
            input.value = '';
          });
        },
        async loadRom() {
          const data = await this.readFile(inputRom);
          this.eggvanceLoadRom(this.fs.write(data));
        },
        async loadSave() {
          const data = await this.readFile(inputSave);
          this.eggvanceLoadSave(this.fs.write(data));
        }
      };

      window.onload = () => {
        const canvas = document.getElementById('canvas');
        const width  = canvas.clientWidth;
        const height = 2 * width / 3;

        const style = document.createElement('style');
        style.appendChild(document.createTextNode(`#canvas { width: ${width}px; height: ${height}px }`));
        document.head.appendChild(style);

        window.onresize = () => {
          style.remove();
          canvas.height = 2 * canvas.width / 3;
        }
      }
    </script>
    <script src="eggvance.js" async></script>
  </body>
</html>
