<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>eggvance</title>
  </head>
  <body>
    <canvas id="canvas" oncontextmenu="event.preventDefault()" style="background-color: black"></canvas>
    <div style="display: flex; margin-top: 8px">
      <div style="margin-right: 8px">
        <button onclick="inputRom.click()">Load rom</button>
        <input id="rom-input" type="file" style="display: none" onchange="Module.loadRom()">
      </div>
      <div>
        <button onclick="inputBackup.click()">Load save</button>
        <input id="backup-input" type="file" style="display: none" onchange="Module.loadBackup()">
      </div>
    </div>
    <script type='text/javascript'>
      const inputRom = document.getElementById('rom-input');
      const inputBackup = document.getElementById('backup-input');

      let fileId = 0;
      var Module = {
        canvas: document.getElementById('canvas'),
        preInit() {
          FS.writeFile('eggvance.toml', `
            [general]
            bios_file = ""
            bios_skip = true
            save_dir = ""
            deadzone = 16000

            [multipliers]
            fps_multiplier_1 = 2.0
            fps_multiplier_2 = 4.0
            fps_multiplier_3 = 6.0
            fps_multiplier_4 = 8.0

            [controls]
            a      = ["U", "B"            ]
            b      = ["H", "A"            ]
            up     = ["W", "DPUP"         ]
            down   = ["S", "DPDOWN"       ]
            left   = ["A", "DPLEFT"       ]
            right  = ["D", "DPRIGHT"      ]
            start  = ["G", "START"        ]
            select = ["F", "BACK"         ]
            l      = ["Q", "LEFTSHOULDER" ]
            r      = ["I", "RIGHTSHOULDER"]

            [shortcuts]
            reset         = ["R", ""]
            fullscreen    = ["T", ""]
            fps_default   = ["1", ""]
            fps_custom_1  = ["2", ""]
            fps_custom_2  = ["3", ""]
            fps_custom_3  = ["4", ""]
            fps_custom_4  = ["5", ""]
            fps_unlimited = ["6", ""]
          `);
        },
        loadFile(input, callback) {
          if (input.files.length === 0)
            return;

          const reader = new FileReader();
          reader.onload = function() {
            callback(new Uint8Array(reader.result));
          }
          reader.readAsArrayBuffer(input.files[0]);
          input.value = '';
        },
        loadRom() {
          this.loadFile(inputRom, data => {
            fileId++;
            FS.writeFile(`rom${fileId}.gba`, data);
            this.eggvanceLoadRom(`rom${fileId}.gba`);
          });
        },
        loadBackup(file) {
          this.loadFile(inputBackup, data => {
            fileId++;
            FS.writeFile(`rom${fileId}.sav`, data);
            this.eggvanceLoadBackup(`rom${fileId}.sav`);
          });
        }
      };
    </script>
    {{{ SCRIPT }}}
  </body>
</html>
